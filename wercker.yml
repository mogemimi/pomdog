box:
  id: mogemimi/gamedev-ubuntu
  username: $DOCKERHUB_USERNAME
  password: $DOCKERHUB_ACCESS_TOKEN

build:
  box:
    id: mogemimi/gamedev-ubuntu
    username: $DOCKERHUB_USERNAME
    password: $DOCKERHUB_ACCESS_TOKEN
  steps:
    - script:
      name: clone third party libraries
      code: |
        git submodule update --init
        git submodule update --init --recursive dependencies/mbedtls

build-clang-debug:
  box:
    id: mogemimi/gamedev-ubuntu
    username: $DOCKERHUB_USERNAME
    password: $DOCKERHUB_ACCESS_TOKEN
  steps:
    - script:
      name: build with clang in debug mode
      code: |
        mkdir build.cmake && cd build.cmake
        cmake \
          -G Ninja \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_CXX_FLAGS="-stdlib=libc++" \
          -DCMAKE_EXE_LINKER_FLAGS="-stdlib=libc++ -lc++abi" \
          -DCMAKE_BUILD_TYPE=Debug \
          ..
        ninja
    - script:
      name: run test
      code: ./build.cmake/test/PomdogTest

build-clang-release:
  box:
    id: mogemimi/gamedev-ubuntu
    username: $DOCKERHUB_USERNAME
    password: $DOCKERHUB_ACCESS_TOKEN
  steps:
    - script:
      name: build with clang in release mode
      code: |
        mkdir build.cmake && cd build.cmake
        cmake \
          -G Ninja \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_CXX_FLAGS="-stdlib=libc++" \
          -DCMAKE_EXE_LINKER_FLAGS="-stdlib=libc++ -lc++abi" \
          -DCMAKE_BUILD_TYPE=Release \
          ..
        ninja
    - script:
      name: run test
      code: ./build.cmake/test/PomdogTest

build-clang-libstdcxx-debug:
  box:
    id: mogemimi/gamedev-ubuntu
    username: $DOCKERHUB_USERNAME
    password: $DOCKERHUB_ACCESS_TOKEN
  steps:
    - script:
      name: build with clang in debug mode
      code: |
        mkdir build.cmake && cd build.cmake
        cmake \
          -G Ninja \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_CXX_FLAGS="-stdlib=libstdc++" \
          -DCMAKE_EXE_LINKER_FLAGS="-stdlib=libstdc++" \
          -DCMAKE_BUILD_TYPE=Debug \
          ..
        ninja
    - script:
      name: run test
      code: ./build.cmake/test/PomdogTest

build-clang-libstdcxx-release:
  box:
    id: mogemimi/gamedev-ubuntu
    username: $DOCKERHUB_USERNAME
    password: $DOCKERHUB_ACCESS_TOKEN
  steps:
    - script:
      name: build with clang in release mode
      code: |
        mkdir build.cmake && cd build.cmake
        cmake \
          -G Ninja \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_CXX_FLAGS="-stdlib=libstdc++" \
          -DCMAKE_EXE_LINKER_FLAGS="-stdlib=libstdc++" \
          -DCMAKE_BUILD_TYPE=Release \
          ..
        ninja
    - script:
      name: run test
      code: ./build.cmake/test/PomdogTest

build-gcc-debug:
  box:
    id: mogemimi/gamedev-archlinux
    username: $DOCKERHUB_USERNAME
    password: $DOCKERHUB_ACCESS_TOKEN
  steps:
    - script:
      name: build with gcc in debug mode
      code: |
        mkdir build.cmake && cd build.cmake
        cmake \
          -G Ninja \
          -DCMAKE_C_COMPILER=gcc \
          -DCMAKE_CXX_COMPILER=g++ \
          -DCMAKE_BUILD_TYPE=Debug \
          ..
        ninja
    - script:
      name: run test
      code: ./build.cmake/test/PomdogTest

build-gcc-release:
  box:
    id: mogemimi/gamedev-archlinux
    username: $DOCKERHUB_USERNAME
    password: $DOCKERHUB_ACCESS_TOKEN
  steps:
    - script:
      name: build with gcc in release mode
      code: |
        mkdir build.cmake && cd build.cmake
        cmake \
          -G Ninja \
          -DCMAKE_C_COMPILER=gcc \
          -DCMAKE_CXX_COMPILER=g++ \
          -DCMAKE_BUILD_TYPE=Release \
          ..
        ninja
    - script:
      name: run test
      code: ./build.cmake/test/PomdogTest

build-emscripten-debug:
  box:
    id: mogemimi/gamedev-emscripten
    username: $DOCKERHUB_USERNAME
    password: $DOCKERHUB_ACCESS_TOKEN
  steps:
    - script:
      name: set the environment variables
      code: source /emsdk/emsdk_env.sh
    - script:
      name: build with emscripten in debug mode
      code: |
        cmake \
          -Bbuild/emscripten \
          -H. \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_TOOLCHAIN_FILE=$EMSDK/upstream/emscripten/cmake/Modules/Platform/Emscripten.cmake
        ninja -C build/emscripten
    - script:
      name: run test
      code: |
        node \
          --experimental-modules \
          --experimental-wasm-modules \
          --experimental-wasm-threads \
          ./build/emscripten/test/PomdogTest.js

build-emscripten-release:
  box:
    id: mogemimi/gamedev-emscripten
    username: $DOCKERHUB_USERNAME
    password: $DOCKERHUB_ACCESS_TOKEN
  steps:
    - script:
      name: set the environment variables
      code: source /emsdk/emsdk_env.sh
    - script:
      name: build with emscripten in release mode
      code: |
        cmake \
          -Bbuild/emscripten \
          -H. \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=$EMSDK/upstream/emscripten/cmake/Modules/Platform/Emscripten.cmake
        ninja -C build/emscripten
    - script:
      name: run test
      code: |
        node \
          --experimental-modules \
          --experimental-wasm-modules \
          --experimental-wasm-threads \
          ./build/emscripten/test/PomdogTest.js
